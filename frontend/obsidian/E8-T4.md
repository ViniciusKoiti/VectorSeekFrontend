# E8-T4 — Integrar Filtro de Workspace

## Objetivo
Integrar filtro de workspace na UI de documentos. O service `listWorkspaces()` já existe, mas não está conectado à interface.

## Dependências
- `E8-T2` (Implementar CRUD de Documentos - para ter lista de documentos funcional)

## Entregáveis
**Legenda de status:** `[x]` Concluído · `[~]` Parcial · `[ ]` Pendente

- [ ] Dropdown/select de workspace na barra de filtros
- [ ] Workspaces carregados ao inicializar página
- [ ] Filtro de documentos por workspace selecionado
- [ ] Preferência de workspace salva no localStorage
- [ ] Restauração de workspace ao recarregar página
- [ ] Testes unitários para filtro

## Especificação Técnica

### 1. Carregar Workspaces

**O que Implementar:**
- [ ] No `DocumentsPageComponent.ngOnInit()`, chamar `WorkspaceService.listWorkspaces()`
- [ ] Armazenar lista em variável de componente
- [ ] Tratar erros se API falhar (fallback: usar workspace default)
- [ ] Exibir spinner enquanto carrega

**Código do Service (já existe):**
```typescript
// Em src/app/services/workspace.service.ts
listWorkspaces(): Observable<Workspace[]>
```

### 2. Dropdown de Workspace

**O que Implementar:**
- [ ] Adicionar `<mat-select>` (Material Select) ou similar na barra de filtros
- [ ] Listar todos os workspaces
- [ ] Mostrar workspace "Todos" como opção padrão
- [ ] Mostrar workspace "default" por padrão

**Template HTML:**
```html
<div class="filters-bar">
  <mat-form-field>
    <mat-label>Workspace</mat-label>
    <mat-select [(ngModel)]="selectedWorkspaceId" (selectionChange)="onWorkspaceChange()">
      <mat-option value="">Todos</mat-option>
      <mat-option *ngFor="let ws of workspaces" [value]="ws.id">
        {{ ws.name }}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <!-- Outros filtros... -->
</div>
```

### 3. Filtrar Documentos por Workspace

**O que Implementar:**
- [ ] Ao mudar workspace, chamar `getDocuments(workspaceId)`
- [ ] Passar `workspaceId` como query parameter para API
- [ ] Atualizar lista de documentos exibida
- [ ] Mostrar spinner durante carregamento

**Código:**
```typescript
onWorkspaceChange() {
  this.isLoading = true;
  this.documentsService.getDocuments(this.selectedWorkspaceId)
    .subscribe({
      next: (documents) => {
        this.documents = documents;
        this.isLoading = false;
        // Salvar preferência
        this.saveWorkspacePreference();
      },
      error: (error) => {
        this.errorMessage = 'Erro ao carregar documentos';
        this.isLoading = false;
      }
    });
}
```

### 4. Persistir Preferência no localStorage

**O que Implementar:**
- [ ] Salvar `selectedWorkspaceId` no localStorage quando muda
- [ ] Carregar preferência ao inicializar página
- [ ] Mostrar workspace anterior ao reabrir aplicação
- [ ] Expirar preferência após logout (limpar localStorage)

**Código:**
```typescript
private saveWorkspacePreference() {
  localStorage.setItem('selectedWorkspaceId', this.selectedWorkspaceId || '');
}

private loadWorkspacePreference() {
  const saved = localStorage.getItem('selectedWorkspaceId');
  this.selectedWorkspaceId = saved || '';
}

ngOnInit() {
  this.loadWorkspacePreference();
  this.loadWorkspaces();
  this.loadDocuments();
}
```

## Estrutura de Componente

**Arquivo afetado:**
- `src/app/features/documents/pages/documents-page.component.ts`
- `src/app/features/documents/pages/documents-page.component.html`

**Adicionar ao componente:**
```typescript
workspaces: Workspace[] = [];
selectedWorkspaceId: string = '';
isLoadingWorkspaces = false;

constructor(
  private documentsService: DocumentsService,
  private workspaceService: WorkspaceService
) {}

ngOnInit() {
  this.loadWorkspacePreference();
  this.loadWorkspaces();
  this.loadDocuments();
}

private loadWorkspaces() {
  this.isLoadingWorkspaces = true;
  this.workspaceService.listWorkspaces()
    .subscribe({
      next: (workspaces) => {
        this.workspaces = workspaces;
        this.isLoadingWorkspaces = false;
      },
      error: (error) => {
        console.error('Erro ao carregar workspaces:', error);
        this.isLoadingWorkspaces = false;
      }
    });
}

onWorkspaceChange() {
  this.loadDocuments();
  this.saveWorkspacePreference();
}

private loadDocuments() {
  this.isLoading = true;
  this.documentsService.getDocuments(this.selectedWorkspaceId)
    .subscribe({
      next: (documents) => {
        this.documents = documents;
        this.isLoading = false;
      },
      error: (error) => {
        this.errorMessage = 'Erro ao carregar documentos';
        this.isLoading = false;
      }
    });
}

private saveWorkspacePreference() {
  localStorage.setItem('selectedWorkspaceId', this.selectedWorkspaceId || '');
}

private loadWorkspacePreference() {
  const saved = localStorage.getItem('selectedWorkspaceId');
  if (saved) {
    this.selectedWorkspaceId = saved;
  }
}
```

## Orientações de Implementação

1. **Carregar Workspaces em Paralelo**
   - Usar `forkJoin()` para carregar workspaces + documentos simultaneamente
   - Melhora performance da página

2. **Tratar Caso Sem Workspaces**
   - Se usuário não tem nenhum workspace, mostrar mensagem
   - Oferecer criar novo workspace

3. **Cache de Workspaces**
   - Considerar cachear lista de workspaces por alguns minutos
   - Reduz chamadas desnecessárias

4. **Acessibilidade**
   - Adicionar ARIA labels ao select
   - Garantir navegação por teclado (tab/enter)

## Padrões de Código Obrigatórios
- Usar Reactive Forms ou two-way binding `[(ngModel)]` com cuidado
- Implementar unsubscribe adequadamente (OnDestroy)
- Usar trackBy em *ngFor para performance
- LocalStorage apenas para preferências não-sensíveis
- Limpar localStorage ao logout

## Testes Obrigatórios
**Legenda de status:** `[x]` Concluído · `[~]` Parcial · `[ ]` Pendente

- [ ] Teste: Workspaces carregam ao inicializar
- [ ] Teste: Ao selecionar workspace, documentos são filtrados
- [ ] Teste: Preferência é salva no localStorage
- [ ] Teste: Ao recarregar página, workspace anterior é restaurado
- [ ] Teste: Erro ao carregar workspaces não quebra página
- [ ] Teste: localStorage é limpo ao logout

## Estimativa
**Responsável:** Frontend Team
**Deadline:** 16 de Novembro
**Estimativa:** 1-2 dias
**Status:** ⏳ Não Iniciado

## Links Relacionados
- [agents_vector_dev.md](../frontend/agents_vector_dev.md)
- [Status_Implementação.md](../frontend/status/Status_Implementação.md)
