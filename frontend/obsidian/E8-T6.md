# E8-T6 — Implementar CRUD de Workspaces

## Objetivo
Implementar endpoints e UI para gerenciar workspaces (criar, editar, deletar). Atualmente apenas listagem está funcional.

## Dependências
- `E8-T1` (Sincronizar endpoints com backend)

## Entregáveis
**Legenda de status:** `[x]` Concluído · `[~]` Parcial · `[ ]` Pendente

### Backend
- [ ] `POST /api/workspaces` — Criar novo workspace
- [ ] `PUT /api/workspaces/:id` — Editar workspace
- [ ] `DELETE /api/workspaces/:id` — Deletar workspace
- [ ] Validações de nome (obrigatório, comprimento)
- [ ] Verificação de permissões (owner can manage)
- [ ] Testes para todos os endpoints

### Frontend
- [ ] Página `/app/workspaces` com listagem
- [ ] Tabela com workspaces (nome, descrição, criado em, ações)
- [ ] Botão "Novo Workspace" abre modal
- [ ] Modal de criação/edição de workspace
- [ ] Modal de confirmação para deletar
- [ ] Feedback visual (toast de sucesso/erro)
- [ ] Testes unitários e integração

## Especificação de Endpoints Backend

### POST /api/workspaces — Criar Workspace

**Request:**
```json
{
  "name": "Meu Workspace",
  "description": "Descrição opcional"
}
```

**Response (201 Created):**
```json
{
  "data": {
    "id": "uuid",
    "name": "Meu Workspace",
    "description": "Descrição opcional",
    "owner_id": "uuid",
    "created_at": "2025-11-12T10:30:00Z",
    "updated_at": "2025-11-12T10:30:00Z"
  }
}
```

**Validações:**
- `name` obrigatório (1-100 caracteres)
- `description` opcional (0-500 caracteres)
- Verificar limite de workspaces por plano (Free: 1, Pro: 5, Enterprise: unlimited)

**Error Responses:**
```json
{
  "error": "Workspace quota exceeded",
  "limit": 1,
  "plan": "free"
}
```

---

### PUT /api/workspaces/:id — Editar Workspace

**Request:**
```json
{
  "name": "Nome Atualizado",
  "description": "Nova descrição"
}
```

**Response (200 OK):**
```json
{
  "data": {
    "id": "uuid",
    "name": "Nome Atualizado",
    "description": "Nova descrição",
    "owner_id": "uuid",
    "created_at": "2025-11-12T10:30:00Z",
    "updated_at": "2025-11-12T11:00:00Z"
  }
}
```

**Validações:**
- Usuário deve ser owner do workspace
- Mesmas validações de campo que criação

**Error Responses:**
```json
{
  "error": "Workspace not found"
}
```

```json
{
  "error": "Not authorized to edit this workspace"
}
```

---

### DELETE /api/workspaces/:id — Deletar Workspace

**Request:**
```
DELETE /api/workspaces/{id}
```

**Response (204 No Content)**

**Validações:**
- Usuário deve ser owner
- Considerar: deletar documentos associados? (soft delete?)
- Documentação de política de retenção

**Error Responses:**
```json
{
  "error": "Workspace not found"
}
```

```json
{
  "error": "Cannot delete workspace with documents"
}
```

---

## Implementação Frontend

### 1. Página de Workspaces

**Arquivo a criar:**
```
src/app/features/workspaces/
├── pages/
│   └── workspaces-page.component.ts      [NOVO]
│       ├── workspaces-page.component.html
│       └── workspaces-page.component.scss
├── components/
│   ├── workspace-list-table/              [NOVO]
│   │   ├── workspace-list-table.component.ts
│   │   ├── workspace-list-table.component.html
│   │   └── workspace-list-table.component.scss
│   ├── workspace-form-modal/              [NOVO]
│   │   ├── workspace-form-modal.component.ts
│   │   ├── workspace-form-modal.component.html
│   │   └── workspace-form-modal.component.scss
│   └── workspace-delete-modal/            [NOVO]
│       ├── workspace-delete-modal.component.ts
│       ├── workspace-delete-modal.component.html
│       └── workspace-delete-modal.component.scss
└── services/
    └── workspace.service.ts               [EXISTENTE - estender]
```

### 2. Service de Workspace

**Métodos a adicionar ao `WorkspaceService`:**
```typescript
// Já existe:
listWorkspaces(): Observable<Workspace[]>

// Adicionar:
createWorkspace(name: string, description?: string): Observable<WorkspaceResponse>
updateWorkspace(id: string, name: string, description?: string): Observable<WorkspaceResponse>
deleteWorkspace(id: string): Observable<void>
```

**Implementação:**
```typescript
@Injectable({
  providedIn: 'root'
})
export class WorkspaceService {
  private apiUrl = '/api/workspaces';

  constructor(private http: HttpClient) {}

  listWorkspaces(): Observable<Workspace[]> {
    return this.http.get<{ data: Workspace[] }>(`${this.apiUrl}`)
      .pipe(
        map(response => response.data)
      );
  }

  createWorkspace(name: string, description?: string): Observable<Workspace> {
    return this.http.post<{ data: Workspace }>(this.apiUrl, {
      name,
      description: description || ''
    }).pipe(
      map(response => response.data)
    );
  }

  updateWorkspace(id: string, name: string, description?: string): Observable<Workspace> {
    return this.http.put<{ data: Workspace }>(`${this.apiUrl}/${id}`, {
      name,
      description: description || ''
    }).pipe(
      map(response => response.data)
    );
  }

  deleteWorkspace(id: string): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }
}
```

### 3. WorkspacesPageComponent

**Template HTML:**
```html
<div class="workspaces-container">
  <div class="header">
    <h2>Meus Workspaces</h2>
    <button mat-raised-button color="primary" (click)="openCreateModal()">
      + Novo Workspace
    </button>
  </div>

  <!-- Modal de Criação/Edição -->
  <app-workspace-form-modal
    *ngIf="showFormModal"
    [workspace]="selectedWorkspace"
    (save)="onWorkspaceSave($event)"
    (cancel)="closeFormModal()">
  </app-workspace-form-modal>

  <!-- Tabela de Workspaces -->
  <app-workspace-list-table
    [workspaces]="workspaces"
    [isLoading]="isLoading"
    (edit)="onEdit($event)"
    (delete)="onDelete($event)">
  </app-workspace-list-table>

  <!-- Modal de Confirmação Delete -->
  <app-workspace-delete-modal
    *ngIf="showDeleteModal"
    [workspace]="selectedWorkspace"
    (confirm)="confirmDelete()"
    (cancel)="closeDeleteModal()">
  </app-workspace-delete-modal>
</div>
```

**Código TypeScript:**
```typescript
@Component({
  selector: 'app-workspaces-page',
  templateUrl: './workspaces-page.component.html',
  styleUrls: ['./workspaces-page.component.scss']
})
export class WorkspacesPageComponent implements OnInit {
  workspaces: Workspace[] = [];
  selectedWorkspace: Workspace | null = null;
  isLoading = false;
  showFormModal = false;
  showDeleteModal = false;

  constructor(
    private workspaceService: WorkspaceService,
    private snackBar: MatSnackBar
  ) {}

  ngOnInit() {
    this.loadWorkspaces();
  }

  private loadWorkspaces() {
    this.isLoading = true;
    this.workspaceService.listWorkspaces()
      .subscribe({
        next: (workspaces) => {
          this.workspaces = workspaces;
          this.isLoading = false;
        },
        error: (error) => {
          this.showError('Erro ao carregar workspaces');
          this.isLoading = false;
        }
      });
  }

  openCreateModal() {
    this.selectedWorkspace = null;
    this.showFormModal = true;
  }

  onEdit(workspace: Workspace) {
    this.selectedWorkspace = workspace;
    this.showFormModal = true;
  }

  onWorkspaceSave(data: { name: string; description?: string }) {
    if (this.selectedWorkspace) {
      this.editWorkspace(this.selectedWorkspace.id, data.name, data.description);
    } else {
      this.createWorkspace(data.name, data.description);
    }
  }

  private createWorkspace(name: string, description?: string) {
    this.workspaceService.createWorkspace(name, description)
      .subscribe({
        next: (workspace) => {
          this.workspaces.unshift(workspace);
          this.closeFormModal();
          this.showSuccess('Workspace criado com sucesso');
        },
        error: (error) => {
          this.showError(error.error.error || 'Erro ao criar workspace');
        }
      });
  }

  private editWorkspace(id: string, name: string, description?: string) {
    this.workspaceService.updateWorkspace(id, name, description)
      .subscribe({
        next: (workspace) => {
          const index = this.workspaces.findIndex(w => w.id === id);
          if (index !== -1) {
            this.workspaces[index] = workspace;
          }
          this.closeFormModal();
          this.showSuccess('Workspace atualizado com sucesso');
        },
        error: (error) => {
          this.showError(error.error.error || 'Erro ao editar workspace');
        }
      });
  }

  onDelete(workspace: Workspace) {
    this.selectedWorkspace = workspace;
    this.showDeleteModal = true;
  }

  confirmDelete() {
    if (!this.selectedWorkspace) return;

    this.workspaceService.deleteWorkspace(this.selectedWorkspace.id)
      .subscribe({
        next: () => {
          this.workspaces = this.workspaces.filter(w => w.id !== this.selectedWorkspace?.id);
          this.closeDeleteModal();
          this.showSuccess('Workspace deletado com sucesso');
        },
        error: (error) => {
          this.showError(error.error.error || 'Erro ao deletar workspace');
        }
      });
  }

  closeFormModal() {
    this.showFormModal = false;
    this.selectedWorkspace = null;
  }

  closeDeleteModal() {
    this.showDeleteModal = false;
    this.selectedWorkspace = null;
  }

  private showSuccess(message: string) {
    this.snackBar.open(message, 'Fechar', { duration: 3000 });
  }

  private showError(message: string) {
    this.snackBar.open(message, 'Fechar', { duration: 5000, panelClass: ['error'] });
  }
}
```

### 4. WorkspaceFormModalComponent

**O que Implementar:**
- [ ] Formulário com campos: nome (obrigatório), descrição (opcional)
- [ ] Validação de campos (nome: 1-100 chars, descrição: 0-500 chars)
- [ ] Botões: Salvar, Cancelar
- [ ] Modal de criação vs edição (título diferente)
- [ ] Pre-preencher campos em modo edição

### 5. WorkspaceListTableComponent

**O que Implementar:**
- [ ] Tabela com colunas: Nome, Descrição, Criado em, Ações
- [ ] Ações: Editar (ícone pencil), Deletar (ícone trash)
- [ ] Loader enquanto carrega
- [ ] Mensagem se vazio
- [ ] Paginação (opcional)

### 6. WorkspaceDeleteModalComponent

**O que Implementar:**
- [ ] Confirmação visual clara
- [ ] Mensagem de aviso: "Esta ação é irreversível"
- [ ] Botões: Cancelar, Confirmar Deletar
- [ ] Desabilitar durante deletion

## Rota no Aplicativo

**Adicionar ao routing:**
```typescript
// app.routes.ts
{
  path: 'app',
  component: AppLayoutComponent,
  children: [
    // ... outras rotas
    {
      path: 'workspaces',
      component: WorkspacesPageComponent
    }
  ]
}
```

**Adicionar link no menu:**
```html
<!-- app-layout.component.html -->
<mat-nav-list>
  <!-- ... outros itens -->
  <mat-list-item routerLink="/app/workspaces" routerLinkActive="active">
    <mat-icon matListItemIcon>workspaces</mat-icon>
    <span matListItemTitle>Workspaces</span>
  </mat-list-item>
</mat-nav-list>
```

## Orientações de Implementação

1. **Validações**
   - Nome: obrigatório, 1-100 caracteres
   - Descrição: opcional, máx 500 caracteres
   - Mostrar erros inline no formulário

2. **Permissões**
   - Verificar se usuário é owner antes de editar/deletar
   - Backend deve validar também

3. **Estado**
   - Desabilitar buttons durante operação
   - Mostrar spinner/loader
   - Atualizar UI após sucesso

4. **Fluxo de Delete**
   - Modal de confirmação clara
   - Avisar sobre implicações (documentos associados)
   - Confirm button em destaque

## Padrões de Código Obrigatórios
- Usar componentes standalone Angular 16+
- Implementar reactive forms
- OnDestroy para unsubscribe
- Error handling robusto
- Material Design components
- Documentar componentes com JSDoc

## Testes Obrigatórios
**Legenda de status:** `[x]` Concluído · `[~]` Parcial · `[ ]` Pendente

### Backend
- [ ] Teste: POST /api/workspaces cria workspace
- [ ] Teste: PUT /api/workspaces/:id edita workspace
- [ ] Teste: DELETE /api/workspaces/:id deleta workspace
- [ ] Teste: Validações de nome/descrição funcionam
- [ ] Teste: Usuário não-owner não pode editar/deletar
- [ ] Teste: Quota de workspaces é respeitada

### Frontend
- [ ] Teste: Página carrega lista de workspaces
- [ ] Teste: Botão "Novo Workspace" abre modal
- [ ] Teste: Formulário valida nome obrigatório
- [ ] Teste: Ao salvar, chamada POST é feita
- [ ] Teste: Ao editar, chamada PUT é feita
- [ ] Teste: Modal de delete requer confirmação
- [ ] Teste: Após delete, workspace é removido da lista
- [ ] Teste: Toast de sucesso/erro aparecem

## Estimativa
**Responsável:** Backend Team (2-3 dias) + Frontend Team (2-3 dias)
**Deadline:** 23 de Novembro
**Estimativa:** 3-4 dias total
**Status:** ⏳ Não Iniciado

## Links Relacionados
- [agents_vector_dev.md](../frontend/agents_vector_dev.md)
- [Status_Implementação.md](../frontend/status/Status_Implementação.md)
