# E8-T9 — Implementar Dashboard/Analytics

## Objetivo
Implementar dashboard com métricas de uso e analytics. Usuários verão estatísticas de documentos processados, perguntas feitas, geração de conteúdo e uso de storage.

## Dependências
- `E8-T2` (Implementar CRUD de Documentos - para ter dados de documentos)
- `E8-T3` (Implementar Upload - para ter dados de processamento)

## Entregáveis
**Legenda de status:** `[x]` Concluído · `[~]` Parcial · `[ ]` Pendente

### Backend
- [ ] `GET /api/analytics/usage` — Métricas gerais de uso
- [ ] `GET /api/analytics/timeline` — Timeline de atividades (gráfico)
- [ ] `GET /api/analytics/documents` — Estatísticas de documentos
- [ ] `GET /api/analytics/storage` — Uso de storage por tipo
- [ ] Cálculos de quotas consumidas vs limites

### Frontend
- [ ] Página `/app/dashboard`
- [ ] Cards com KPIs (Perguntas, Documentos, Gerações, Storage)
- [ ] Gráfico de uso ao longo do tempo (linha)
- [ ] Gráfico de distribuição por tipo (pizza)
- [ ] Alertas de limite próximo
- [ ] Testes unitários

## Especificação de Endpoints Backend

### GET /api/analytics/usage — Métricas Gerais

**Response (200 OK):**
```json
{
  "data": {
    "questions_asked": 42,
    "documents_processed": 15,
    "generations_created": 8,
    "tokens_used": 125000,
    "storage_used_mb": 234.5,
    "quotas": {
      "documents_limit": 50,
      "documents_used": 15,
      "documents_percentage": 30,
      "llm_tokens_limit": 1000000,
      "llm_tokens_used": 125000,
      "llm_tokens_percentage": 12.5,
      "audio_minutes_limit": 60,
      "audio_minutes_used": 10,
      "audio_minutes_percentage": 16.6,
      "video_minutes_limit": 30,
      "video_minutes_used": 0,
      "video_minutes_percentage": 0,
      "storage_limit_mb": 1000,
      "storage_used_mb": 234.5,
      "storage_percentage": 23.4
    },
    "plan": "pro",
    "period": "2025-11 (November)"
  }
}
```

### GET /api/analytics/timeline — Timeline de Atividades

**Query Parameters:**
```
start_date: ISO 8601 (último 30 dias por padrão)
end_date: ISO 8601
period: "day" | "week" | "month" (granularidade)
```

**Response (200 OK):**
```json
{
  "data": {
    "daily": [
      {
        "date": "2025-11-01",
        "questions": 5,
        "documents_processed": 2,
        "generations": 1,
        "tokens_used": 15000
      },
      {
        "date": "2025-11-02",
        "questions": 8,
        "documents_processed": 3,
        "generations": 2,
        "tokens_used": 22000
      }
      // ... mais dias
    ]
  }
}
```

### GET /api/analytics/documents — Estatísticas de Documentos

**Response (200 OK):**
```json
{
  "data": {
    "total_documents": 15,
    "by_status": {
      "completed": 12,
      "processing": 2,
      "failed": 1
    },
    "by_type": {
      "pdf": 7,
      "docx": 5,
      "txt": 2,
      "md": 1
    },
    "total_chunks": 1250,
    "avg_chunks_per_doc": 83,
    "total_size_mb": 156,
    "avg_processing_time_seconds": 45
  }
}
```

### GET /api/analytics/storage — Uso de Storage

**Response (200 OK):**
```json
{
  "data": {
    "by_type": {
      "documents": {
        "size_mb": 156,
        "percentage": 66.6
      },
      "generated_content": {
        "size_mb": 62,
        "percentage": 26.5
      },
      "embeddings": {
        "size_mb": 16.5,
        "percentage": 7.0
      }
    },
    "total_size_mb": 234.5,
    "limit_mb": 1000
  }
}
```

---

## Implementação Frontend

### 1. DashboardPageComponent

**Arquivo a criar:**
```
src/app/features/dashboard/
├── pages/
│   └── dashboard-page.component.ts          [NOVO]
│       ├── dashboard-page.component.html
│       └── dashboard-page.component.scss
├── components/
│   ├── usage-kpi-cards/                     [NOVO]
│   │   ├── usage-kpi-cards.component.ts
│   │   ├── usage-kpi-cards.component.html
│   │   └── usage-kpi-cards.component.scss
│   ├── usage-timeline-chart/                [NOVO]
│   │   ├── usage-timeline-chart.component.ts
│   │   ├── usage-timeline-chart.component.html
│   │   └── usage-timeline-chart.component.scss
│   ├── document-distribution-chart/         [NOVO]
│   │   ├── document-distribution-chart.component.ts
│   │   ├── document-distribution-chart.component.html
│   │   └── document-distribution-chart.component.scss
│   ├── storage-breakdown/                   [NOVO]
│   │   ├── storage-breakdown.component.ts
│   │   ├── storage-breakdown.component.html
│   │   └── storage-breakdown.component.scss
│   └── quota-alerts/                        [NOVO]
│       ├── quota-alerts.component.ts
│       ├── quota-alerts.component.html
│       └── quota-alerts.component.scss
└── services/
    └── analytics.service.ts                 [NOVO]
```

### 2. AnalyticsService

**Métodos:**
```typescript
@Injectable({
  providedIn: 'root'
})
export class AnalyticsService {
  private apiUrl = '/api/analytics';

  constructor(private http: HttpClient) {}

  getUsage(): Observable<UsageMetrics> {
    return this.http.get<{ data: UsageMetrics }>(
      `${this.apiUrl}/usage`
    ).pipe(
      map(response => response.data)
    );
  }

  getTimeline(
    startDate?: string,
    endDate?: string,
    period?: 'day' | 'week' | 'month'
  ): Observable<TimelineData> {
    const params = new HttpParams();
    if (startDate) params = params.set('start_date', startDate);
    if (endDate) params = params.set('end_date', endDate);
    if (period) params = params.set('period', period);

    return this.http.get<{ data: TimelineData }>(
      `${this.apiUrl}/timeline`,
      { params }
    ).pipe(
      map(response => response.data)
    );
  }

  getDocumentStats(): Observable<DocumentStats> {
    return this.http.get<{ data: DocumentStats }>(
      `${this.apiUrl}/documents`
    ).pipe(
      map(response => response.data)
    );
  }

  getStorageBreakdown(): Observable<StorageBreakdown> {
    return this.http.get<{ data: StorageBreakdown }>(
      `${this.apiUrl}/storage`
    ).pipe(
      map(response => response.data)
    );
  }
}
```

**Tipos:**
```typescript
interface UsageMetrics {
  questions_asked: number;
  documents_processed: number;
  generations_created: number;
  tokens_used: number;
  storage_used_mb: number;
  quotas: QuotaInfo;
  plan: string;
  period: string;
}

interface QuotaInfo {
  documents_limit: number;
  documents_used: number;
  documents_percentage: number;
  llm_tokens_limit: number;
  llm_tokens_used: number;
  llm_tokens_percentage: number;
  // ... outros quotas
}

interface TimelineData {
  daily: TimelineEntry[];
}

interface TimelineEntry {
  date: string;
  questions: number;
  documents_processed: number;
  generations: number;
  tokens_used: number;
}

interface DocumentStats {
  total_documents: number;
  by_status: { [key: string]: number };
  by_type: { [key: string]: number };
  total_chunks: number;
  avg_chunks_per_doc: number;
  total_size_mb: number;
  avg_processing_time_seconds: number;
}

interface StorageBreakdown {
  by_type: {
    [key: string]: {
      size_mb: number;
      percentage: number;
    };
  };
  total_size_mb: number;
  limit_mb: number;
}
```

### 3. DashboardPageComponent

**Template HTML:**
```html
<div class="dashboard-container">
  <div class="header">
    <h2>Dashboard</h2>
    <p class="subtitle">Visão geral de seu uso da plataforma</p>
  </div>

  <!-- Loading State -->
  <mat-spinner *ngIf="isLoading" diameter="50"></mat-spinner>

  <ng-container *ngIf="!isLoading">
    <!-- KPI Cards -->
    <app-usage-kpi-cards [metrics]="metrics"></app-usage-kpi-cards>

    <!-- Quota Alerts -->
    <app-quota-alerts
      [quotas]="metrics?.quotas"
      *ngIf="metrics?.quotas">
    </app-quota-alerts>

    <!-- Charts Row -->
    <div class="charts-row">
      <!-- Timeline Chart -->
      <app-usage-timeline-chart
        [timelineData]="timelineData"
        (dateRangeChange)="onDateRangeChange($event)">
      </app-usage-timeline-chart>

      <!-- Document Distribution -->
      <app-document-distribution-chart
        [documentStats]="documentStats">
      </app-document-distribution-chart>
    </div>

    <!-- Storage Breakdown -->
    <app-storage-breakdown
      [storageData]="storageData">
    </app-storage-breakdown>
  </ng-container>
</div>
```

**Código TypeScript:**
```typescript
@Component({
  selector: 'app-dashboard-page',
  templateUrl: './dashboard-page.component.html',
  styleUrls: ['./dashboard-page.component.scss']
})
export class DashboardPageComponent implements OnInit, OnDestroy {
  isLoading = true;
  metrics: UsageMetrics;
  timelineData: TimelineData;
  documentStats: DocumentStats;
  storageData: StorageBreakdown;

  private destroy$ = new Subject<void>();

  constructor(private analyticsService: AnalyticsService) {}

  ngOnInit() {
    this.loadAllData();
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
  }

  private loadAllData() {
    this.isLoading = true;

    // Carregar todos os dados em paralelo
    forkJoin([
      this.analyticsService.getUsage(),
      this.analyticsService.getTimeline(),
      this.analyticsService.getDocumentStats(),
      this.analyticsService.getStorageBreakdown()
    ])
      .pipe(
        takeUntil(this.destroy$),
        finalize(() => { this.isLoading = false; })
      )
      .subscribe({
        next: ([metrics, timeline, docs, storage]) => {
          this.metrics = metrics;
          this.timelineData = timeline;
          this.documentStats = docs;
          this.storageData = storage;
        },
        error: (error) => {
          console.error('Erro ao carregar dashboard:', error);
        }
      });
  }

  onDateRangeChange(range: { start: string; end: string }) {
    this.isLoading = true;
    this.analyticsService.getTimeline(range.start, range.end)
      .pipe(takeUntil(this.destroy$))
      .subscribe({
        next: (timeline) => {
          this.timelineData = timeline;
          this.isLoading = false;
        },
        error: (error) => {
          console.error('Erro ao atualizar timeline:', error);
          this.isLoading = false;
        }
      });
  }
}
```

### 4. UsageKPICardsComponent

**O que Implementar:**
- [ ] Cards com KPIs: Perguntas, Documentos, Gerações, Storage
- [ ] Ícone para cada métrica
- [ ] Número grande e destacado
- [ ] Comparação anterior (opcional: +5 vs semana passada)
- [ ] Grid responsivo (4 colunas em desktop, 2 em tablet, 1 em mobile)

**Template:**
```html
<div class="kpi-cards-grid">
  <mat-card class="kpi-card">
    <mat-card-header>
      <div class="kpi-icon" [style.background-color]="'#FF6B6B'">
        <mat-icon>help</mat-icon>
      </div>
    </mat-card-header>
    <mat-card-content>
      <h3>Perguntas Feitas</h3>
      <p class="kpi-value">{{ metrics.questions_asked }}</p>
    </mat-card-content>
  </mat-card>

  <mat-card class="kpi-card">
    <mat-card-header>
      <div class="kpi-icon" [style.background-color]="'#4ECDC4'">
        <mat-icon>description</mat-icon>
      </div>
    </mat-card-header>
    <mat-card-content>
      <h3>Documentos</h3>
      <p class="kpi-value">{{ metrics.documents_processed }}</p>
    </mat-card-content>
  </mat-card>

  <mat-card class="kpi-card">
    <mat-card-header>
      <div class="kpi-icon" [style.background-color]="'#95E1D3'">
        <mat-icon>auto_awesome</mat-icon>
      </div>
    </mat-card-header>
    <mat-card-content>
      <h3>Gerações</h3>
      <p class="kpi-value">{{ metrics.generations_created }}</p>
    </mat-card-content>
  </mat-card>

  <mat-card class="kpi-card">
    <mat-card-header>
      <div class="kpi-icon" [style.background-color]="'#F38181'">
        <mat-icon>storage</mat-icon>
      </div>
    </mat-card-header>
    <mat-card-content>
      <h3>Storage</h3>
      <p class="kpi-value">{{ metrics.storage_used_mb | number:'1.1' }} MB</p>
    </mat-card-content>
  </mat-card>
</div>
```

### 5. UsageTimelineChartComponent

**O que Implementar:**
- [ ] Gráfico de linha (Chart.js ou ngx-charts)
- [ ] Eixo X: datas
- [ ] Eixo Y: múltiplas linhas (perguntas, documentos, gerações)
- [ ] Seletor de intervalo de datas
- [ ] Tooltip ao passar mouse
- [ ] Responsivo

### 6. DocumentDistributionChartComponent

**O que Implementar:**
- [ ] Gráfico de pizza mostrando distribuição por tipo (PDF, DOCX, etc.)
- [ ] Legenda com cores
- [ ] Valores percentuais
- [ ] Hover mostra número absoluto

### 7. StorageBreakdownComponent

**O que Implementar:**
- [ ] Gráfico de barras (ou progresso) mostrando uso por tipo
- [ ] Documentos, Conteúdo Gerado, Embeddings
- [ ] Barra de progresso do limite total
- [ ] Cores visuais: vermelho se > 90%, amarelo se > 70%

### 8. QuotaAlertsComponent

**O que Implementar:**
- [ ] Cards de alerta para quotas próximas do limite
- [ ] Exibir se > 80% de qualquer quota
- [ ] Cores: verde < 70%, amarelo 70-90%, vermelho > 90%
- [ ] Link para upgrade de plano se necessário

## Rota no Aplicativo

**Adicionar ao routing:**
```typescript
{
  path: 'app',
  component: AppLayoutComponent,
  children: [
    {
      path: 'dashboard',
      component: DashboardPageComponent
    }
    // ... outras rotas
  ]
}
```

**Definir como rota padrão:**
```typescript
{
  path: 'app',
  redirectTo: 'app/dashboard',
  pathMatch: 'full'
}
```

## Orientações de Implementação

1. **Gráficos**
   - Usar Chart.js ou ngx-charts
   - Responsivo e acessível
   - Cores consistentes com design system

2. **Performance**
   - Carregar dados em paralelo com forkJoin
   - Cache de 5 minutos (rxjs shareReplay)
   - Lazy load de gráficos se necessário

3. **Acessibilidade**
   - Descrever gráficos com texto alternativo
   - Tabela de dados para leitores de tela
   - Suficiente contraste de cores

4. **Alertas**
   - Avisar se quota próxima de 80%
   - Vermelho se exceder limite
   - Link para upgrade

## Padrões de Código Obrigatórios
- forkJoin para múltiplas requisições paralelas
- OnDestroy com takeUntil para unsubscribe
- Material Design components
- Responsivo com media queries
- Documentar com JSDoc
- Error handling robusto

## Testes Obrigatórios
**Legenda de status:** `[x]` Concluído · `[~]` Parcial · `[ ]` Pendente

### Backend
- [ ] Teste: GET /api/analytics/usage retorna métricas corretas
- [ ] Teste: GET /api/analytics/timeline funciona com filtros de data
- [ ] Teste: Cálculos de percentuais estão corretos
- [ ] Teste: Quotas refletem uso real do usuário

### Frontend
- [ ] Teste: Dashboard carrega dados ao inicializar
- [ ] Teste: KPI cards exibem valores corretos
- [ ] Teste: Gráficos renderizam
- [ ] Teste: Alertas de quota aparecem quando necessário
- [ ] Teste: Filtro de data atualiza timeline
- [ ] Teste: Responsividade em diferentes tamanhos

## Estimativa
**Responsável:** Backend Team (1-2 dias) + Frontend Team (3-4 dias)
**Deadline:** 7 de Dezembro
**Estimativa:** 3-4 dias total
**Status:** ⏳ Não Iniciado

## Links Relacionados
- [agents_vector_dev.md](../frontend/agents_vector_dev.md)
- [Status_Implementação.md](../frontend/status/Status_Implementação.md)
