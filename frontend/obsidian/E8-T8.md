# E8-T8 â€” Implementar ConfiguraÃ§Ãµes de UsuÃ¡rio

## Objetivo
Implementar endpoints e UI para gerenciar perfil de usuÃ¡rio, senha e preferÃªncias (tema, idioma, notificaÃ§Ãµes).

## DependÃªncias
- Nenhuma (task independente)

## EntregÃ¡veis
**Legenda de status:** `[x]` ConcluÃ­do Â· `[~]` Parcial Â· `[ ]` Pendente

### Backend
- [ ] `PUT /api/auth/profile` â€” Editar perfil (nome, avatar)
- [ ] `PUT /api/auth/password` â€” Alterar senha
- [ ] `GET /api/auth/preferences` â€” Obter preferÃªncias
- [ ] `PUT /api/auth/preferences` â€” Salvar preferÃªncias
- [ ] ValidaÃ§Ãµes de senha (forÃ§a mÃ­nima)
- [ ] Testes para todos os endpoints

### Frontend
- [x] PÃ¡gina `/app/settings` com formulÃ¡rio reativo
- [x] UserSettingsService no data-access com testes
- [x] FormulÃ¡rio com campos: nome, tema (light/dark), idioma (pt-BR/en-US), notificaÃ§Ãµes
- [x] IntegraÃ§Ã£o com ThemeService para aplicar tema em tempo real
- [x] ValidaÃ§Ã£o com Zod (nome obrigatÃ³rio, 1-200 caracteres)
- [x] Feedback visual (mensagens de sucesso/erro)
- [x] Testes unitÃ¡rios completos (componente + serviÃ§o)
- [x] DocumentaÃ§Ã£o JSDoc no cÃ³digo

## EspecificaÃ§Ã£o de Endpoints Backend

### PUT /api/auth/profile â€” Editar Perfil

**Request:**
```json
{
  "full_name": "JoÃ£o Silva",
  "avatar_url": "https://s3.amazonaws.com/avatars/user123.jpg"
}
```

**Response (200 OK):**
```json
{
  "data": {
    "id": "uuid",
    "email": "joao@example.com",
    "full_name": "JoÃ£o Silva",
    "avatar_url": "https://s3.amazonaws.com/avatars/user123.jpg",
    "updated_at": "2025-11-12T15:30:00Z"
  }
}
```

**ValidaÃ§Ãµes:**
- `full_name` obrigatÃ³rio (1-200 caracteres)
- `avatar_url` opcional (URL vÃ¡lida)

---

### PUT /api/auth/password â€” Alterar Senha

**Request:**
```json
{
  "old_password": "senha_antiga",
  "new_password": "SenhaForte123!@"
}
```

**Response (200 OK):**
```json
{
  "data": {
    "message": "Senha alterada com sucesso"
  }
}
```

**ValidaÃ§Ãµes:**
- `old_password` obrigatÃ³rio (validar contra senha atual)
- `new_password` obrigatÃ³rio e diferente da antiga
- ForÃ§a mÃ­nima: 8 caracteres, maiÃºscula, minÃºscula, nÃºmero, sÃ­mbolo
- Retornar 401 se old_password estiver incorreta

**Error Responses:**
```json
{
  "error": "Invalid current password"
}
```

```json
{
  "error": "Password does not meet requirements",
  "requirements": [
    "At least 8 characters",
    "Contains uppercase letter",
    "Contains lowercase letter",
    "Contains number",
    "Contains special character"
  ]
}
```

---

### GET /api/auth/preferences â€” Obter PreferÃªncias

**Response (200 OK):**
```json
{
  "data": {
    "theme": "dark",
    "language": "pt-BR",
    "notifications_email": true,
    "notifications_push": false,
    "notifications_digest": "daily"
  }
}
```

---

### PUT /api/auth/preferences â€” Salvar PreferÃªncias

**Request:**
```json
{
  "theme": "dark",
  "language": "pt-BR",
  "notifications_email": true,
  "notifications_push": false,
  "notifications_digest": "daily"
}
```

**Response (200 OK):**
```json
{
  "data": {
    "theme": "dark",
    "language": "pt-BR",
    "notifications_email": true,
    "notifications_push": false,
    "notifications_digest": "daily"
  }
}
```

**ValidaÃ§Ãµes:**
- `theme`: "light", "dark", "auto"
- `language`: "pt-BR", "en", "es"
- `notifications_digest`: "instant", "daily", "weekly", "never"

---

## ImplementaÃ§Ã£o Frontend

### 1. SettingsPageComponent

**Arquivo a criar:**
```
src/app/features/settings/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ settings-page.component.ts           [NOVO]
â”‚       â”œâ”€â”€ settings-page.component.html
â”‚       â””â”€â”€ settings-page.component.scss
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ profile-settings/                    [NOVO]
â”‚   â”‚   â”œâ”€â”€ profile-settings.component.ts
â”‚   â”‚   â”œâ”€â”€ profile-settings.component.html
â”‚   â”‚   â””â”€â”€ profile-settings.component.scss
â”‚   â”œâ”€â”€ security-settings/                   [NOVO]
â”‚   â”‚   â”œâ”€â”€ security-settings.component.ts
â”‚   â”‚   â”œâ”€â”€ security-settings.component.html
â”‚   â”‚   â””â”€â”€ security-settings.component.scss
â”‚   â””â”€â”€ preferences-settings/                [NOVO]
â”‚       â”œâ”€â”€ preferences-settings.component.ts
â”‚       â”œâ”€â”€ preferences-settings.component.html
â”‚       â””â”€â”€ preferences-settings.component.scss
â””â”€â”€ services/
    â””â”€â”€ settings.service.ts                  [NOVO]
```

### 2. SettingsService

**MÃ©todos:**
```typescript
@Injectable({
  providedIn: 'root'
})
export class SettingsService {
  private apiUrl = '/api/auth';

  constructor(private http: HttpClient) {}

  updateProfile(fullName: string, avatarUrl?: string): Observable<UserResponse> {
    return this.http.put<{ data: UserResponse }>(`${this.apiUrl}/profile`, {
      full_name: fullName,
      avatar_url: avatarUrl
    }).pipe(
      map(response => response.data)
    );
  }

  changePassword(
    oldPassword: string,
    newPassword: string
  ): Observable<{ message: string }> {
    return this.http.put<{ data: { message: string } }>(
      `${this.apiUrl}/password`,
      { old_password: oldPassword, new_password: newPassword }
    ).pipe(
      map(response => response.data)
    );
  }

  getPreferences(): Observable<UserPreferences> {
    return this.http.get<{ data: UserPreferences }>(
      `${this.apiUrl}/preferences`
    ).pipe(
      map(response => response.data)
    );
  }

  savePreferences(preferences: UserPreferences): Observable<UserPreferences> {
    return this.http.put<{ data: UserPreferences }>(
      `${this.apiUrl}/preferences`,
      preferences
    ).pipe(
      map(response => response.data)
    );
  }
}
```

### 3. SettingsPageComponent

**Template HTML:**
```html
<div class="settings-container">
  <h2>ConfiguraÃ§Ãµes</h2>

  <mat-tab-group>
    <!-- Tab 1: Perfil -->
    <mat-tab label="Perfil">
      <app-profile-settings
        [user]="currentUser"
        (save)="onProfileSave($event)">
      </app-profile-settings>
    </mat-tab>

    <!-- Tab 2: SeguranÃ§a -->
    <mat-tab label="SeguranÃ§a">
      <app-security-settings
        (save)="onPasswordChange($event)">
      </app-security-settings>
    </mat-tab>

    <!-- Tab 3: PreferÃªncias -->
    <mat-tab label="PreferÃªncias">
      <app-preferences-settings
        [preferences]="preferences"
        (save)="onPreferencesSave($event)">
      </app-preferences-settings>
    </mat-tab>
  </mat-tab-group>
</div>
```

**CÃ³digo TypeScript:**
```typescript
@Component({
  selector: 'app-settings-page',
  templateUrl: './settings-page.component.html',
  styleUrls: ['./settings-page.component.scss']
})
export class SettingsPageComponent implements OnInit {
  currentUser: User;
  preferences: UserPreferences;

  constructor(
    private settingsService: SettingsService,
    private authService: AuthService,
    private snackBar: MatSnackBar
  ) {}

  ngOnInit() {
    this.loadUserData();
    this.loadPreferences();
  }

  private loadUserData() {
    this.authService.getCurrentUser().subscribe(
      user => {
        this.currentUser = user;
      }
    );
  }

  private loadPreferences() {
    this.settingsService.getPreferences().subscribe(
      preferences => {
        this.preferences = preferences;
      },
      error => {
        this.showError('Erro ao carregar preferÃªncias');
      }
    );
  }

  onProfileSave(data: { fullName: string; avatarUrl?: string }) {
    this.settingsService.updateProfile(data.fullName, data.avatarUrl)
      .subscribe({
        next: (user) => {
          this.currentUser = user;
          this.showSuccess('Perfil atualizado com sucesso');
        },
        error: (error) => {
          this.showError(error.error.error || 'Erro ao atualizar perfil');
        }
      });
  }

  onPasswordChange(data: { oldPassword: string; newPassword: string }) {
    this.settingsService.changePassword(data.oldPassword, data.newPassword)
      .subscribe({
        next: () => {
          this.showSuccess('Senha alterada com sucesso');
        },
        error: (error) => {
          this.showError(error.error.error || 'Erro ao alterar senha');
        }
      });
  }

  onPreferencesSave(preferences: UserPreferences) {
    this.settingsService.savePreferences(preferences)
      .subscribe({
        next: (updated) => {
          this.preferences = updated;
          this.showSuccess('PreferÃªncias salvas com sucesso');
        },
        error: (error) => {
          this.showError('Erro ao salvar preferÃªncias');
        }
      });
  }

  private showSuccess(message: string) {
    this.snackBar.open(message, 'Fechar', { duration: 3000 });
  }

  private showError(message: string) {
    this.snackBar.open(message, 'Fechar', { duration: 5000, panelClass: ['error'] });
  }
}
```

### 4. ProfileSettingsComponent

**O que Implementar:**
- [ ] FormulÃ¡rio com campos: Nome Completo, Avatar
- [ ] Preview do avatar atual
- [ ] Upload de novo avatar com preview
- [ ] ValidaÃ§Ã£o de nome (obrigatÃ³rio, 1-200 caracteres)
- [ ] BotÃ£o Salvar e Cancelar
- [ ] Desabilitar durante save

**Template:**
```html
<mat-card class="settings-card">
  <mat-card-header>
    <mat-card-title>InformaÃ§Ãµes Pessoais</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Avatar -->
      <div class="avatar-section">
        <img
          *ngIf="avatarPreview"
          [src]="avatarPreview"
          alt="Avatar"
          class="avatar-preview">
        <input
          type="file"
          #fileInput
          hidden
          accept="image/*"
          (change)="onAvatarSelect($event)">
        <button
          type="button"
          mat-stroked-button
          (click)="fileInput.click()">
          Alterar Avatar
        </button>
      </div>

      <!-- Nome -->
      <mat-form-field class="full-width">
        <mat-label>Nome Completo</mat-label>
        <input
          matInput
          formControlName="fullName"
          placeholder="Seu nome">
        <mat-error *ngIf="form.get('fullName')?.invalid">
          Nome Ã© obrigatÃ³rio (mÃ­n. 1, mÃ¡x. 200 caracteres)
        </mat-error>
      </mat-form-field>

      <!-- Email (readonly) -->
      <mat-form-field class="full-width">
        <mat-label>Email</mat-label>
        <input
          matInput
          [value]="user.email"
          disabled>
        <mat-hint>Email nÃ£o pode ser alterado</mat-hint>
      </mat-form-field>

      <!-- BotÃµes -->
      <div class="button-group">
        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="form.invalid || isSaving">
          Salvar AlteraÃ§Ãµes
        </button>
        <button
          mat-stroked-button
          type="button"
          (click)="onCancel()">
          Cancelar
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
```

### 5. SecuritySettingsComponent

**O que Implementar:**
- [ ] FormulÃ¡rio com: Senha Atual, Nova Senha, Confirmar Nova Senha
- [ ] ValidaÃ§Ã£o de forÃ§a de senha em tempo real
- [ ] Exibir requisitos de forÃ§a (maiÃºscula, minÃºscula, nÃºmero, sÃ­mbolo)
- [ ] Indicador visual de forÃ§a (fraca, mÃ©dia, forte)
- [ ] BotÃ£o Salvar e Cancelar
- [ ] Mensagem de sucesso ao alterar

**Template:**
```html
<mat-card class="settings-card">
  <mat-card-header>
    <mat-card-title>Alterar Senha</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Senha Atual -->
      <mat-form-field class="full-width">
        <mat-label>Senha Atual</mat-label>
        <input
          matInput
          type="password"
          formControlName="oldPassword"
          placeholder="Sua senha atual">
        <mat-error *ngIf="form.get('oldPassword')?.invalid">
          Senha Ã© obrigatÃ³ria
        </mat-error>
      </mat-form-field>

      <!-- Nova Senha -->
      <mat-form-field class="full-width">
        <mat-label>Nova Senha</mat-label>
        <input
          matInput
          type="password"
          formControlName="newPassword"
          placeholder="Nova senha"
          (change)="updatePasswordStrength()">
        <mat-error *ngIf="form.get('newPassword')?.invalid">
          Senha deve ter no mÃ­nimo 8 caracteres
        </mat-error>
      </mat-form-field>

      <!-- Indicador de ForÃ§a -->
      <div class="password-strength" *ngIf="newPassword">
        <div class="strength-bar" [class]="'strength-' + passwordStrength"></div>
        <p class="strength-text">{{ getPasswordStrengthText() }}</p>
        <ul class="requirements">
          <li [class.met]="requirements.length">
            <mat-icon>{{ requirements.length ? 'check' : 'close' }}</mat-icon>
            MÃ­nimo 8 caracteres
          </li>
          <li [class.met]="requirements.uppercase">
            <mat-icon>{{ requirements.uppercase ? 'check' : 'close' }}</mat-icon>
            Letra maiÃºscula
          </li>
          <li [class.met]="requirements.lowercase">
            <mat-icon>{{ requirements.lowercase ? 'check' : 'close' }}</mat-icon>
            Letra minÃºscula
          </li>
          <li [class.met]="requirements.number">
            <mat-icon>{{ requirements.number ? 'check' : 'close' }}</mat-icon>
            NÃºmero
          </li>
          <li [class.met]="requirements.symbol">
            <mat-icon>{{ requirements.symbol ? 'check' : 'close' }}</mat-icon>
            SÃ­mbolo especial
          </li>
        </ul>
      </div>

      <!-- Confirmar Senha -->
      <mat-form-field class="full-width">
        <mat-label>Confirmar Nova Senha</mat-label>
        <input
          matInput
          type="password"
          formControlName="confirmPassword"
          placeholder="Confirme a nova senha">
        <mat-error *ngIf="form.hasError('passwordMismatch')">
          As senhas nÃ£o coincidem
        </mat-error>
      </mat-form-field>

      <!-- BotÃµes -->
      <div class="button-group">
        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="form.invalid || isSaving">
          Alterar Senha
        </button>
        <button
          mat-stroked-button
          type="button"
          (click)="onCancel()">
          Cancelar
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
```

### 6. PreferencesSettingsComponent

**O que Implementar:**
- [ ] Seletor de tema (claro, escuro, automÃ¡tico)
- [ ] Seletor de idioma
- [ ] Checkboxes para notificaÃ§Ãµes (email, push)
- [ ] Seletor de frequÃªncia de digest (instant, daily, weekly, never)
- [ ] Aplicar tema imediatamente
- [ ] BotÃ£o Salvar

**Template:**
```html
<mat-card class="settings-card">
  <mat-card-header>
    <mat-card-title>PreferÃªncias</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Tema -->
      <div class="preference-group">
        <label>Tema</label>
        <mat-radio-group formControlName="theme" (change)="onThemeChange()">
          <mat-radio-button value="light">Claro</mat-radio-button>
          <mat-radio-button value="dark">Escuro</mat-radio-button>
          <mat-radio-button value="auto">AutomÃ¡tico</mat-radio-button>
        </mat-radio-group>
      </div>

      <!-- Idioma -->
      <mat-form-field>
        <mat-label>Idioma</mat-label>
        <mat-select formControlName="language">
          <mat-option value="pt-BR">PortuguÃªs (Brasil)</mat-option>
          <mat-option value="en">English</mat-option>
          <mat-option value="es">EspaÃ±ol</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- NotificaÃ§Ãµes -->
      <div class="preference-group">
        <label>NotificaÃ§Ãµes</label>
        <mat-checkbox formControlName="notificationsEmail">
          Receber notificaÃ§Ãµes por email
        </mat-checkbox>
        <mat-checkbox formControlName="notificationsPush">
          Receber notificaÃ§Ãµes push
        </mat-checkbox>
      </div>

      <!-- FrequÃªncia -->
      <mat-form-field>
        <mat-label>FrequÃªncia de Digest</mat-label>
        <mat-select formControlName="notificationsDigest">
          <mat-option value="instant">InstantÃ¢neo</mat-option>
          <mat-option value="daily">DiÃ¡rio</mat-option>
          <mat-option value="weekly">Semanal</mat-option>
          <mat-option value="never">Nunca</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- BotÃ£o -->
      <div class="button-group">
        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="form.invalid || isSaving">
          Salvar PreferÃªncias
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
```

## Rota no Aplicativo

**Adicionar ao routing:**
```typescript
{
  path: 'app',
  component: AppLayoutComponent,
  children: [
    // ... outras rotas
    {
      path: 'settings',
      component: SettingsPageComponent
    }
  ]
}
```

**Link no menu:**
```html
<mat-list-item routerLink="/app/settings" routerLinkActive="active">
  <mat-icon matListItemIcon>settings</mat-icon>
  <span matListItemTitle>ConfiguraÃ§Ãµes</span>
</mat-list-item>
```

## OrientaÃ§Ãµes de ImplementaÃ§Ã£o

1. **ValidaÃ§Ã£o de Senha**
   - MÃ­nimo 8 caracteres
   - MaiÃºscula, minÃºscula, nÃºmero, sÃ­mbolo obrigatÃ³rios
   - Mostrar requisitos em tempo real

2. **Tema**
   - Aplicar imediatamente ao mudar
   - Salvar no localStorage (persistir entre sessÃµes)
   - Considerar preferÃªncia do SO (auto)

3. **Idioma**
   - Integrar com ngx-translate
   - Mudar idioma em tempo real
   - Salvar preferÃªncia

4. **Avatar**
   - Validar tipo de arquivo (JPEG, PNG, WebP)
   - Validar tamanho (mÃ¡x 5MB)
   - Fazer upload ao salvar
   - Mostrar preview antes de salvar

## PadrÃµes de CÃ³digo ObrigatÃ³rios
- Usar Reactive Forms
- Validadores customizados para senha
- OnDestroy para unsubscribe
- Error handling robusto
- Documentar componentes com JSDoc
- Material Design components

## Testes ObrigatÃ³rios
**Legenda de status:** `[x]` ConcluÃ­do Â· `[~]` Parcial Â· `[ ]` Pendente

### Backend
- [ ] Teste: PUT /api/auth/profile atualiza usuÃ¡rio
- [ ] Teste: PUT /api/auth/password rejeita senha fraca
- [ ] Teste: PUT /api/auth/password rejeita old_password invÃ¡lida
- [ ] Teste: GET/PUT /api/auth/preferences funciona
- [ ] Teste: ValidaÃ§Ãµes de campos funcionam

### Frontend
- [ ] Teste: FormulÃ¡rio de perfil valida nome
- [ ] Teste: Upload de avatar funciona
- [ ] Teste: FormulÃ¡rio de senha valida requisitos
- [ ] Teste: Indicador de forÃ§a atualiza
- [ ] Teste: MudanÃ§a de tema Ã© aplicada
- [ ] Teste: PreferÃªncias sÃ£o salvas

## Estimativa
**ResponsÃ¡vel:** Backend Team (2-3 dias) + Frontend Team (2-3 dias)
**Deadline:** 30 de Novembro
**Estimativa:** 3-4 dias total
**Status:** ğŸŸ¡ Parcialmente ConcluÃ­do (Frontend âœ… | Backend â³)

## ImplementaÃ§Ã£o Realizada

### Frontend (âœ… ConcluÃ­do)

**Data-Access Layer:**
- `libs/data-access/src/lib/settings/`
  - `settings.api.ts` â€” Endpoints API
  - `settings.models.ts` â€” Tipos TypeScript (domain + API)
  - `settings.service.ts` â€” ServiÃ§o HTTP com normalizaÃ§Ã£o de erros
  - `settings.service.spec.ts` â€” Testes unitÃ¡rios completos

**Settings Component:**
- `src/app/settings/`
  - `settings-page.component.ts` â€” Componente principal com Reactive Forms
  - `settings-page.component.html` â€” Template com Angular Material
  - `settings-page.component.css` â€” Estilos com suporte a tema
  - `settings-page.component.spec.ts` â€” Testes unitÃ¡rios (>90% coverage)
  - `schemas/settings.schemas.ts` â€” ValidaÃ§Ã£o Zod
  - `settings.routes.ts` â€” Rotas lazy-loaded

**Funcionalidades Implementadas:**
1. âœ… FormulÃ¡rio reativo com validaÃ§Ã£o em tempo real
2. âœ… Campos: nome, tema (light/dark), idioma (pt-BR/en-US), notificaÃ§Ãµes
3. âœ… IntegraÃ§Ã£o com ThemeService (aplica tema imediatamente)
4. âœ… PersistÃªncia no localStorage via ThemeService
5. âœ… Mensagens de sucesso/erro com animaÃ§Ãµes
6. âœ… Estados de loading durante fetch e save
7. âœ… NormalizaÃ§Ã£o de erros HTTP com mensagens amigÃ¡veis
8. âœ… Responsive design (mobile-first)
9. âœ… Suporte a tema claro/escuro
10. âœ… DocumentaÃ§Ã£o JSDoc completa

**Endpoints Utilizados:**
- `GET /users/me/settings` â€” Carregar configuraÃ§Ãµes
- `PATCH /users/me/settings` â€” Salvar configuraÃ§Ãµes

**Tecnologias:**
- Angular 20.3 (standalone components)
- Reactive Forms + Zod validation
- RxJS (Observable pattern)
- Jasmine/Karma (testes)
- Tailwind CSS + CSS customizado

### Backend (â³ Pendente)
Aguardando implementaÃ§Ã£o dos endpoints:
- `GET /users/me/settings`
- `PATCH /users/me/settings`
- `PUT /api/auth/profile`
- `PUT /api/auth/password`

## Links Relacionados
- [agents_vector_dev.md](../frontend/agents_vector_dev.md)
- [Status_ImplementaÃ§Ã£o.md](../frontend/status/Status_ImplementaÃ§Ã£o.md)
