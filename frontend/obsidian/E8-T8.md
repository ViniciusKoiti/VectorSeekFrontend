# E8-T8 — Implementar Configurações de Usuário

## Objetivo
Implementar endpoints e UI para gerenciar perfil de usuário, senha e preferências (tema, idioma, notificações).

## Dependências
- Nenhuma (task independente)

## Entregáveis
**Legenda de status:** `[x]` Concluído · `[~]` Parcial · `[ ]` Pendente

### Backend
- [ ] `PUT /api/auth/profile` — Editar perfil (nome, avatar)
- [ ] `PUT /api/auth/password` — Alterar senha
- [ ] `GET /api/auth/preferences` — Obter preferências
- [ ] `PUT /api/auth/preferences` — Salvar preferências
- [ ] Validações de senha (força mínima)
- [ ] Testes para todos os endpoints

### Frontend
- [ ] Página `/app/settings` com abas
- [ ] Aba "Perfil" — editar nome, upload avatar
- [ ] Aba "Segurança" — alterar senha
- [ ] Aba "Preferências" — tema, idioma, notificações
- [ ] Feedback visual (toast de sucesso/erro)
- [ ] Testes unitários

## Especificação de Endpoints Backend

### PUT /api/auth/profile — Editar Perfil

**Request:**
```json
{
  "full_name": "João Silva",
  "avatar_url": "https://s3.amazonaws.com/avatars/user123.jpg"
}
```

**Response (200 OK):**
```json
{
  "data": {
    "id": "uuid",
    "email": "joao@example.com",
    "full_name": "João Silva",
    "avatar_url": "https://s3.amazonaws.com/avatars/user123.jpg",
    "updated_at": "2025-11-12T15:30:00Z"
  }
}
```

**Validações:**
- `full_name` obrigatório (1-200 caracteres)
- `avatar_url` opcional (URL válida)

---

### PUT /api/auth/password — Alterar Senha

**Request:**
```json
{
  "old_password": "senha_antiga",
  "new_password": "SenhaForte123!@"
}
```

**Response (200 OK):**
```json
{
  "data": {
    "message": "Senha alterada com sucesso"
  }
}
```

**Validações:**
- `old_password` obrigatório (validar contra senha atual)
- `new_password` obrigatório e diferente da antiga
- Força mínima: 8 caracteres, maiúscula, minúscula, número, símbolo
- Retornar 401 se old_password estiver incorreta

**Error Responses:**
```json
{
  "error": "Invalid current password"
}
```

```json
{
  "error": "Password does not meet requirements",
  "requirements": [
    "At least 8 characters",
    "Contains uppercase letter",
    "Contains lowercase letter",
    "Contains number",
    "Contains special character"
  ]
}
```

---

### GET /api/auth/preferences — Obter Preferências

**Response (200 OK):**
```json
{
  "data": {
    "theme": "dark",
    "language": "pt-BR",
    "notifications_email": true,
    "notifications_push": false,
    "notifications_digest": "daily"
  }
}
```

---

### PUT /api/auth/preferences — Salvar Preferências

**Request:**
```json
{
  "theme": "dark",
  "language": "pt-BR",
  "notifications_email": true,
  "notifications_push": false,
  "notifications_digest": "daily"
}
```

**Response (200 OK):**
```json
{
  "data": {
    "theme": "dark",
    "language": "pt-BR",
    "notifications_email": true,
    "notifications_push": false,
    "notifications_digest": "daily"
  }
}
```

**Validações:**
- `theme`: "light", "dark", "auto"
- `language`: "pt-BR", "en", "es"
- `notifications_digest`: "instant", "daily", "weekly", "never"

---

## Implementação Frontend

### 1. SettingsPageComponent

**Arquivo a criar:**
```
src/app/features/settings/
├── pages/
│   └── settings-page.component.ts           [NOVO]
│       ├── settings-page.component.html
│       └── settings-page.component.scss
├── components/
│   ├── profile-settings/                    [NOVO]
│   │   ├── profile-settings.component.ts
│   │   ├── profile-settings.component.html
│   │   └── profile-settings.component.scss
│   ├── security-settings/                   [NOVO]
│   │   ├── security-settings.component.ts
│   │   ├── security-settings.component.html
│   │   └── security-settings.component.scss
│   └── preferences-settings/                [NOVO]
│       ├── preferences-settings.component.ts
│       ├── preferences-settings.component.html
│       └── preferences-settings.component.scss
└── services/
    └── settings.service.ts                  [NOVO]
```

### 2. SettingsService

**Métodos:**
```typescript
@Injectable({
  providedIn: 'root'
})
export class SettingsService {
  private apiUrl = '/api/auth';

  constructor(private http: HttpClient) {}

  updateProfile(fullName: string, avatarUrl?: string): Observable<UserResponse> {
    return this.http.put<{ data: UserResponse }>(`${this.apiUrl}/profile`, {
      full_name: fullName,
      avatar_url: avatarUrl
    }).pipe(
      map(response => response.data)
    );
  }

  changePassword(
    oldPassword: string,
    newPassword: string
  ): Observable<{ message: string }> {
    return this.http.put<{ data: { message: string } }>(
      `${this.apiUrl}/password`,
      { old_password: oldPassword, new_password: newPassword }
    ).pipe(
      map(response => response.data)
    );
  }

  getPreferences(): Observable<UserPreferences> {
    return this.http.get<{ data: UserPreferences }>(
      `${this.apiUrl}/preferences`
    ).pipe(
      map(response => response.data)
    );
  }

  savePreferences(preferences: UserPreferences): Observable<UserPreferences> {
    return this.http.put<{ data: UserPreferences }>(
      `${this.apiUrl}/preferences`,
      preferences
    ).pipe(
      map(response => response.data)
    );
  }
}
```

### 3. SettingsPageComponent

**Template HTML:**
```html
<div class="settings-container">
  <h2>Configurações</h2>

  <mat-tab-group>
    <!-- Tab 1: Perfil -->
    <mat-tab label="Perfil">
      <app-profile-settings
        [user]="currentUser"
        (save)="onProfileSave($event)">
      </app-profile-settings>
    </mat-tab>

    <!-- Tab 2: Segurança -->
    <mat-tab label="Segurança">
      <app-security-settings
        (save)="onPasswordChange($event)">
      </app-security-settings>
    </mat-tab>

    <!-- Tab 3: Preferências -->
    <mat-tab label="Preferências">
      <app-preferences-settings
        [preferences]="preferences"
        (save)="onPreferencesSave($event)">
      </app-preferences-settings>
    </mat-tab>
  </mat-tab-group>
</div>
```

**Código TypeScript:**
```typescript
@Component({
  selector: 'app-settings-page',
  templateUrl: './settings-page.component.html',
  styleUrls: ['./settings-page.component.scss']
})
export class SettingsPageComponent implements OnInit {
  currentUser: User;
  preferences: UserPreferences;

  constructor(
    private settingsService: SettingsService,
    private authService: AuthService,
    private snackBar: MatSnackBar
  ) {}

  ngOnInit() {
    this.loadUserData();
    this.loadPreferences();
  }

  private loadUserData() {
    this.authService.getCurrentUser().subscribe(
      user => {
        this.currentUser = user;
      }
    );
  }

  private loadPreferences() {
    this.settingsService.getPreferences().subscribe(
      preferences => {
        this.preferences = preferences;
      },
      error => {
        this.showError('Erro ao carregar preferências');
      }
    );
  }

  onProfileSave(data: { fullName: string; avatarUrl?: string }) {
    this.settingsService.updateProfile(data.fullName, data.avatarUrl)
      .subscribe({
        next: (user) => {
          this.currentUser = user;
          this.showSuccess('Perfil atualizado com sucesso');
        },
        error: (error) => {
          this.showError(error.error.error || 'Erro ao atualizar perfil');
        }
      });
  }

  onPasswordChange(data: { oldPassword: string; newPassword: string }) {
    this.settingsService.changePassword(data.oldPassword, data.newPassword)
      .subscribe({
        next: () => {
          this.showSuccess('Senha alterada com sucesso');
        },
        error: (error) => {
          this.showError(error.error.error || 'Erro ao alterar senha');
        }
      });
  }

  onPreferencesSave(preferences: UserPreferences) {
    this.settingsService.savePreferences(preferences)
      .subscribe({
        next: (updated) => {
          this.preferences = updated;
          this.showSuccess('Preferências salvas com sucesso');
        },
        error: (error) => {
          this.showError('Erro ao salvar preferências');
        }
      });
  }

  private showSuccess(message: string) {
    this.snackBar.open(message, 'Fechar', { duration: 3000 });
  }

  private showError(message: string) {
    this.snackBar.open(message, 'Fechar', { duration: 5000, panelClass: ['error'] });
  }
}
```

### 4. ProfileSettingsComponent

**O que Implementar:**
- [ ] Formulário com campos: Nome Completo, Avatar
- [ ] Preview do avatar atual
- [ ] Upload de novo avatar com preview
- [ ] Validação de nome (obrigatório, 1-200 caracteres)
- [ ] Botão Salvar e Cancelar
- [ ] Desabilitar durante save

**Template:**
```html
<mat-card class="settings-card">
  <mat-card-header>
    <mat-card-title>Informações Pessoais</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Avatar -->
      <div class="avatar-section">
        <img
          *ngIf="avatarPreview"
          [src]="avatarPreview"
          alt="Avatar"
          class="avatar-preview">
        <input
          type="file"
          #fileInput
          hidden
          accept="image/*"
          (change)="onAvatarSelect($event)">
        <button
          type="button"
          mat-stroked-button
          (click)="fileInput.click()">
          Alterar Avatar
        </button>
      </div>

      <!-- Nome -->
      <mat-form-field class="full-width">
        <mat-label>Nome Completo</mat-label>
        <input
          matInput
          formControlName="fullName"
          placeholder="Seu nome">
        <mat-error *ngIf="form.get('fullName')?.invalid">
          Nome é obrigatório (mín. 1, máx. 200 caracteres)
        </mat-error>
      </mat-form-field>

      <!-- Email (readonly) -->
      <mat-form-field class="full-width">
        <mat-label>Email</mat-label>
        <input
          matInput
          [value]="user.email"
          disabled>
        <mat-hint>Email não pode ser alterado</mat-hint>
      </mat-form-field>

      <!-- Botões -->
      <div class="button-group">
        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="form.invalid || isSaving">
          Salvar Alterações
        </button>
        <button
          mat-stroked-button
          type="button"
          (click)="onCancel()">
          Cancelar
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
```

### 5. SecuritySettingsComponent

**O que Implementar:**
- [ ] Formulário com: Senha Atual, Nova Senha, Confirmar Nova Senha
- [ ] Validação de força de senha em tempo real
- [ ] Exibir requisitos de força (maiúscula, minúscula, número, símbolo)
- [ ] Indicador visual de força (fraca, média, forte)
- [ ] Botão Salvar e Cancelar
- [ ] Mensagem de sucesso ao alterar

**Template:**
```html
<mat-card class="settings-card">
  <mat-card-header>
    <mat-card-title>Alterar Senha</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Senha Atual -->
      <mat-form-field class="full-width">
        <mat-label>Senha Atual</mat-label>
        <input
          matInput
          type="password"
          formControlName="oldPassword"
          placeholder="Sua senha atual">
        <mat-error *ngIf="form.get('oldPassword')?.invalid">
          Senha é obrigatória
        </mat-error>
      </mat-form-field>

      <!-- Nova Senha -->
      <mat-form-field class="full-width">
        <mat-label>Nova Senha</mat-label>
        <input
          matInput
          type="password"
          formControlName="newPassword"
          placeholder="Nova senha"
          (change)="updatePasswordStrength()">
        <mat-error *ngIf="form.get('newPassword')?.invalid">
          Senha deve ter no mínimo 8 caracteres
        </mat-error>
      </mat-form-field>

      <!-- Indicador de Força -->
      <div class="password-strength" *ngIf="newPassword">
        <div class="strength-bar" [class]="'strength-' + passwordStrength"></div>
        <p class="strength-text">{{ getPasswordStrengthText() }}</p>
        <ul class="requirements">
          <li [class.met]="requirements.length">
            <mat-icon>{{ requirements.length ? 'check' : 'close' }}</mat-icon>
            Mínimo 8 caracteres
          </li>
          <li [class.met]="requirements.uppercase">
            <mat-icon>{{ requirements.uppercase ? 'check' : 'close' }}</mat-icon>
            Letra maiúscula
          </li>
          <li [class.met]="requirements.lowercase">
            <mat-icon>{{ requirements.lowercase ? 'check' : 'close' }}</mat-icon>
            Letra minúscula
          </li>
          <li [class.met]="requirements.number">
            <mat-icon>{{ requirements.number ? 'check' : 'close' }}</mat-icon>
            Número
          </li>
          <li [class.met]="requirements.symbol">
            <mat-icon>{{ requirements.symbol ? 'check' : 'close' }}</mat-icon>
            Símbolo especial
          </li>
        </ul>
      </div>

      <!-- Confirmar Senha -->
      <mat-form-field class="full-width">
        <mat-label>Confirmar Nova Senha</mat-label>
        <input
          matInput
          type="password"
          formControlName="confirmPassword"
          placeholder="Confirme a nova senha">
        <mat-error *ngIf="form.hasError('passwordMismatch')">
          As senhas não coincidem
        </mat-error>
      </mat-form-field>

      <!-- Botões -->
      <div class="button-group">
        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="form.invalid || isSaving">
          Alterar Senha
        </button>
        <button
          mat-stroked-button
          type="button"
          (click)="onCancel()">
          Cancelar
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
```

### 6. PreferencesSettingsComponent

**O que Implementar:**
- [ ] Seletor de tema (claro, escuro, automático)
- [ ] Seletor de idioma
- [ ] Checkboxes para notificações (email, push)
- [ ] Seletor de frequência de digest (instant, daily, weekly, never)
- [ ] Aplicar tema imediatamente
- [ ] Botão Salvar

**Template:**
```html
<mat-card class="settings-card">
  <mat-card-header>
    <mat-card-title>Preferências</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Tema -->
      <div class="preference-group">
        <label>Tema</label>
        <mat-radio-group formControlName="theme" (change)="onThemeChange()">
          <mat-radio-button value="light">Claro</mat-radio-button>
          <mat-radio-button value="dark">Escuro</mat-radio-button>
          <mat-radio-button value="auto">Automático</mat-radio-button>
        </mat-radio-group>
      </div>

      <!-- Idioma -->
      <mat-form-field>
        <mat-label>Idioma</mat-label>
        <mat-select formControlName="language">
          <mat-option value="pt-BR">Português (Brasil)</mat-option>
          <mat-option value="en">English</mat-option>
          <mat-option value="es">Español</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Notificações -->
      <div class="preference-group">
        <label>Notificações</label>
        <mat-checkbox formControlName="notificationsEmail">
          Receber notificações por email
        </mat-checkbox>
        <mat-checkbox formControlName="notificationsPush">
          Receber notificações push
        </mat-checkbox>
      </div>

      <!-- Frequência -->
      <mat-form-field>
        <mat-label>Frequência de Digest</mat-label>
        <mat-select formControlName="notificationsDigest">
          <mat-option value="instant">Instantâneo</mat-option>
          <mat-option value="daily">Diário</mat-option>
          <mat-option value="weekly">Semanal</mat-option>
          <mat-option value="never">Nunca</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Botão -->
      <div class="button-group">
        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="form.invalid || isSaving">
          Salvar Preferências
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
```

## Rota no Aplicativo

**Adicionar ao routing:**
```typescript
{
  path: 'app',
  component: AppLayoutComponent,
  children: [
    // ... outras rotas
    {
      path: 'settings',
      component: SettingsPageComponent
    }
  ]
}
```

**Link no menu:**
```html
<mat-list-item routerLink="/app/settings" routerLinkActive="active">
  <mat-icon matListItemIcon>settings</mat-icon>
  <span matListItemTitle>Configurações</span>
</mat-list-item>
```

## Orientações de Implementação

1. **Validação de Senha**
   - Mínimo 8 caracteres
   - Maiúscula, minúscula, número, símbolo obrigatórios
   - Mostrar requisitos em tempo real

2. **Tema**
   - Aplicar imediatamente ao mudar
   - Salvar no localStorage (persistir entre sessões)
   - Considerar preferência do SO (auto)

3. **Idioma**
   - Integrar com ngx-translate
   - Mudar idioma em tempo real
   - Salvar preferência

4. **Avatar**
   - Validar tipo de arquivo (JPEG, PNG, WebP)
   - Validar tamanho (máx 5MB)
   - Fazer upload ao salvar
   - Mostrar preview antes de salvar

## Padrões de Código Obrigatórios
- Usar Reactive Forms
- Validadores customizados para senha
- OnDestroy para unsubscribe
- Error handling robusto
- Documentar componentes com JSDoc
- Material Design components

## Testes Obrigatórios
**Legenda de status:** `[x]` Concluído · `[~]` Parcial · `[ ]` Pendente

### Backend
- [ ] Teste: PUT /api/auth/profile atualiza usuário
- [ ] Teste: PUT /api/auth/password rejeita senha fraca
- [ ] Teste: PUT /api/auth/password rejeita old_password inválida
- [ ] Teste: GET/PUT /api/auth/preferences funciona
- [ ] Teste: Validações de campos funcionam

### Frontend
- [ ] Teste: Formulário de perfil valida nome
- [ ] Teste: Upload de avatar funciona
- [ ] Teste: Formulário de senha valida requisitos
- [ ] Teste: Indicador de força atualiza
- [ ] Teste: Mudança de tema é aplicada
- [ ] Teste: Preferências são salvas

## Estimativa
**Responsável:** Backend Team (2-3 dias) + Frontend Team (2-3 dias)
**Deadline:** 30 de Novembro
**Estimativa:** 3-4 dias total
**Status:** ⏳ Não Iniciado

## Links Relacionados
- [agents_vector_dev.md](../frontend/agents_vector_dev.md)
- [Status_Implementação.md](../frontend/status/Status_Implementação.md)
