# E8-T3 ‚Äî Implementar Upload de Documentos

## Objetivo
Implementar funcionalidade cr√≠tica de upload de documentos no frontend e backend. Usu√°rios precisam conseguir adicionar documentos ao sistema.

## Depend√™ncias
- `E8-T1` (Sincronizar endpoints - para confirmar backend est√° preparado)

## Status Geral
- **Backend:** ‚úÖ Confirmado em 15 Nov 2025 (todos os endpoints e valida√ß√µes descritos em E8-T1, com rate limiting, quota e processamento ass√≠ncrono documentados)
- **Frontend:** ‚úÖ Implementado em 19 Nov 2025 (`DocumentUploadComponent`, `UploadProgressComponent` e integra√ß√£o no `DocumentsPageComponent`)
- **Testes:** ‚úÖ `document-upload.component.spec.ts` cobre valida√ß√£o de tamanho/tipo, progresso, tratamento de erros e emiss√£o de eventos

## Entreg√°veis
**Legenda de status:** `[x]` Conclu√≠do ¬∑ `[~]` Parcial ¬∑ `[ ]` Pendente

### Backend
- [x] Endpoint `POST /api/documents/upload` implementado (ver documenta√ß√£o confirmada em E8-T1)
- [x] Valida√ß√£o de arquivo (tipo, tamanho)
- [x] Verifica√ß√£o de limite por plano
- [x] Rate limiting (5 uploads/min)
- [x] Response 202 Accepted com `documentId` e status
- [x] Async processing via Celery + documenta√ß√£o

### Frontend
- [x] `DocumentUploadComponent` criado com drag-and-drop (`src/app/qna/documents/components/document-upload`)
- [x] Valida√ß√£o de tipo/tamanho no cliente (regras em `validateFile`)
- [x] Progress bar visual durante upload (`UploadProgressComponent` + `uploadProgress` signal)
- [x] Bot√£o na p√°gina de documentos para iniciar upload (`DocumentsPageComponent.openUploadDialog`)
- [x] Lista de documentos atualizada ap√≥s upload (`loadDocuments(1)` ap√≥s dialog close)
- [x] Feedback de sucesso/erro para usu√°rio (snackbars/ mensagens reativas)
- [x] Testes unit√°rios (`document-upload.component.spec.ts`)

## Especifica√ß√£o do Endpoint Backend

### POST /api/documents/upload

**Request (multipart/form-data):**
```
Content-Type: multipart/form-data

Fields:
  - file: File (obrigat√≥rio, ‚â§ 100MB)
    Tipos aceitos: PDF, DOCX, TXT, MD
  - workspaceId: string (opcional)
  - title: string (opcional, usa nome do arquivo se n√£o informado)
```

**Response (202 Accepted):**
```json
{
  "data": {
    "documentId": "uuid",
    "title": "Meu Documento",
    "status": "pending",
    "message": "Upload iniciado. Processamento em andamento."
  }
}
```

**Valida√ß√µes Backend:**
- Arquivo ‚â§ 100MB (retornar 413 se exceder)
- Tipo MIME deve estar em lista branca (PDF, DOCX, TXT, MD)
- Verificar quota do usu√°rio (limite de documentos por plano)
- Rate limiting: m√°ximo 5 uploads/min por usu√°rio
- Salvar arquivo em S3/MinIO
- Iniciar job Celery para processamento

**Error Responses:**
```json
{
  "error": "File too large",
  "max_size_mb": 100,
  "received_size_mb": 150
}
```

```json
{
  "error": "Invalid file type",
  "accepted_types": ["application/pdf", "application/vnd.openxmlformats-officedocument.wordprocessingml.document"]
}
```

```json
{
  "error": "Document quota exceeded",
  "limit": 50,
  "current": 50,
  "plan": "free"
}
```

## Implementa√ß√£o Frontend

### 1. DocumentUploadComponent (Standalone)

**O que Implementar:**
- [x] Componente standalone Angular
- [x] Zona drag-and-drop com visual feedback
- [x] Valida√ß√£o de tipo/tamanho no cliente **antes** de fazer upload
- [x] Seletor de arquivo via input (fallback)
- [x] Progress bar animado durante upload
- [x] Mensagem de status (uploading, processing, success, error)
- [x] Bot√£o de cancelar (se aplic√°vel)

**Estrutura:**
```
src/app/features/documents/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ document-upload/                    [NOVO]
‚îÇ       ‚îú‚îÄ‚îÄ document-upload.component.ts
‚îÇ       ‚îú‚îÄ‚îÄ document-upload.component.html
‚îÇ       ‚îú‚îÄ‚îÄ document-upload.component.scss
‚îÇ       ‚îî‚îÄ‚îÄ document-upload.component.spec.ts
```

**Exemplo de C√≥digo:**
```typescript
@Component({
  selector: 'app-document-upload',
  standalone: true,
  imports: [CommonModule, MaterialModule],
  templateUrl: './document-upload.component.html',
  styleUrls: ['./document-upload.component.scss']
})
export class DocumentUploadComponent {
  @Output() uploadComplete = new EventEmitter<UploadResponse>();

  uploadProgress = 0;
  isUploading = false;
  errorMessage = '';

  constructor(private documentsService: DocumentsService) {}

  onDragOver(event: DragEvent) {
    event.preventDefault();
    // Add visual feedback
  }

  onFileDrop(event: DragEvent) {
    event.preventDefault();
    const files = event.dataTransfer?.files;
    if (files) {
      this.handleFiles(files);
    }
  }

  onFileSelected(event: Event) {
    const input = event.target as HTMLInputElement;
    if (input.files) {
      this.handleFiles(input.files);
    }
  }

  private handleFiles(files: FileList) {
    const file = files[0];

    // Client-side validation
    const maxSize = 100 * 1024 * 1024; // 100MB
    const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain', 'text/markdown'];

    if (file.size > maxSize) {
      this.errorMessage = `Arquivo muito grande (m√°x: 100MB)`;
      return;
    }

    if (!allowedTypes.includes(file.type)) {
      this.errorMessage = `Tipo n√£o permitido. Aceitos: PDF, DOCX, TXT, MD`;
      return;
    }

    this.uploadFile(file);
  }

  private uploadFile(file: File) {
    this.isUploading = true;
    this.errorMessage = '';

    this.documentsService.uploadDocument(file)
      .subscribe({
        next: (response) => {
          this.uploadComplete.emit(response);
          this.isUploading = false;
        },
        error: (error) => {
          this.errorMessage = error.error.error || 'Erro ao fazer upload';
          this.isUploading = false;
        }
      });
  }
}
```

### 2. UploadProgressComponent

**O que Implementar:**
- [x] Componente para exibir progress bar
- [x] Anima√ß√£o suave da barra
- [x] Percentual de progresso
- [x] Mensagem de status
- [x] Tempo estimado (se dispon√≠vel)

### 3. Integra√ß√£o em DocumentsPageComponent

**O que Fazer:**
- [x] Adicionar `<app-document-upload>` √† p√°gina
- [x] Modal ou se√ß√£o expans√≠vel para upload
- [x] Ao upload completar, recarregar lista de documentos
- [x] Exibir documento rec√©m-adicionado no topo da lista

**Template HTML:**
```html
<div class="documents-container">
  <div class="header">
    <h2>Meus Documentos</h2>
    <button (click)="openUploadModal()">+ Upload Documento</button>
  </div>

  <!-- Upload Modal -->
  <mat-dialog #uploadDialog>
    <h2 mat-dialog-title>Adicionar Documento</h2>
    <mat-dialog-content>
      <app-document-upload (uploadComplete)="onUploadComplete($event)"></app-document-upload>
    </mat-dialog-content>
  </mat-dialog>

  <!-- Documentos List -->
  <mat-table [dataSource]="documents">
    <!-- ... colunas da tabela -->
  </mat-table>
</div>
```

## Orienta√ß√µes de Implementa√ß√£o

### Backend
1. **Criar Handler de Upload**
   - Receber `multipart/form-data`
   - Validar arquivo antes de salvar
   - Salvar em S3/MinIO com path organizado por user_id

2. **Integra√ß√£o Celery**
   - Criar task `process_document.py`
   - Task deve: extrair texto, chunkar, vetorizar
   - Atualizar status de documento em tempo real

3. **Database**
   - Adicionar campos se necess√°rio: `file_path`, `file_size`, `original_filename`
   - Considerar soft delete (n√£o f√≠sico)

### Frontend
1. **HTTP Interceptor para Upload**
   - Capturar eventos de progress (`HttpProgressEvent`)
   - Atualizar barra de progresso em tempo real

2. **Tratamento de Erro Robusto**
   - Valida√ß√£o dual (cliente + servidor)
   - Mensagens claras para usu√°rio
   - Retry autom√°tico para erros de rede?

3. **UX/Accessibility**
   - Drag-and-drop + input file (fallback)
   - Disabled durante processamento
   - ARIA labels para acessibilidade

## Padr√µes de C√≥digo Obrigat√≥rios
- Usar FormData API para multipart/form-data
- Implementar `HttpClient.post()` com `reportProgress: true`
- Valida√ß√£o dual (cliente + servidor)
- Tratamento de AbortController para cancelamento
- Documentar limites (100MB) e tipos aceitos
- Usar OnDestroy para unsubscribe de observables
- Logging estruturado de erros

## Testes Obrigat√≥rios
**Legenda de status:** `[x]` Conclu√≠do ¬∑ `[~]` Parcial ¬∑ `[ ]` Pendente

### Frontend
- [x] Teste: Componente rejeita arquivo > 100MB antes de enviar (`document-upload.component.spec.ts`)
- [x] Teste: Componente rejeita tipo n√£o aceito (ex: .exe)
- [x] Teste: Progress bar atualiza corretamente
- [x] Teste: Erro do servidor √© exibido ao usu√°rio
- [x] Teste: `uploadComplete` emit ao sucesso
- [ ] Teste: Lista √© atualizada ap√≥s upload (verificar integra√ß√£o completa em `DocumentsPageComponent`)

### Backend
- [ ] Teste: 413 Payload Too Large se arquivo > 100MB
- [ ] Teste: 400 Bad Request se tipo n√£o permitido
- [ ] Teste: 429 Too Many Requests se > 5 uploads/min
- [ ] Teste: 402 Payment Required se quota excedida
- [ ] Teste: 202 Accepted com documentId v√°lido
- [ ] Teste: Arquivo salvo corretamente em S3/MinIO
- [ ] Teste: Job Celery enfileirado corretamente

## Estimativa
**Respons√°vel:** Backend Team (3-4 dias) + Frontend Team (2-3 dias)
**Deadline:** 19 de Novembro (1 semana)
**Status:** ‚úÖ Conclu√≠do (upload de documentos dispon√≠vel no app Angular)
**Prioridade:** üî¥ CR√çTICA - Resolvida

## Links Relacionados
- [Endpoints_Pendentes.md](../frontend/status/Endpoints_Pendentes.md#21-upload-de-documento)
- [agents_vector_dev.md](../frontend/agents_vector_dev.md)
- CLAUDE.md ‚Äî Padr√µes de c√≥digo do projeto
