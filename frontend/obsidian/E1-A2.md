---
id: E1-A2
epic: "Épico 1 — Fundação de Autenticação & Shell da Aplicação"
status: backlog
tags:
  - frontend
  - angular
  - autenticacao
  - obsidian/backlog
dependencies:
  - E1-A1
obsidian-link: "[[E1-A2 Implementar interceptores e refresh token]]"
---

# E1-A2 · Implementar interceptores e refresh token

## Descrição técnica
- Criar `AuthInterceptor` em `libs/data-access/src/lib/interceptors` para anexar bearer token em todas as requisições `/api/*`.
- Implementar `RefreshTokenService` com fila de requisições simultâneas, utilizando `switchMap` e `shareReplay` para evitar tempestades de refresh.
- Tratar respostas 401/419 renovando sessão e redirecionando para `/auth/login` quando refresh falhar.
- Adicionar `PlanHeaderInterceptor` para enviar `X-User-Plan` configurável conforme escopo do usuário.
- Cobrir comportamento com testes unitários simulando múltiplas requisições paralelas.

## Dependências
- [[E1-A1 Configurar módulo de autenticação]].

## Critérios de aceite
- Interceptores registrados no `app.config.ts` com providers adequados para SSR (`provideHttpClient` + interceptores).
- Refresh token executa apenas uma requisição por ciclo e distribui resultado para chamadas pendentes.
- Testes validam fluxo feliz e tratamento de falhas (401/403/429).

## Checklist sugerido
- [ ] Criar interceptor de autenticação e registrá-lo no provider raiz.
- [ ] Implementar serviço de refresh com fila.
- [ ] Adicionar cabeçalho de plano (`X-User-Plan`).
- [ ] Cobrir cenários com testes unitários.
- [ ] Documentar sequência de eventos no README do módulo.
