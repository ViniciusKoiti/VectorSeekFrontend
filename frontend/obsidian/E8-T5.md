# E8-T5 — Implementar Botão Cancelar Geração

## Objetivo
Implementar UI para cancelar geração de documentos em progresso. O service `cancelGeneration()` já existe no backend, falta integração no frontend.

## Dependências
- Nenhuma (task independente)

## Entregáveis
**Legenda de status:** `[x]` Concluído · `[~]` Parcial · `[ ]` Pendente

- [ ] Botão "Cancelar" adicionado ao `GenerationProgressComponent`
- [ ] Modal de confirmação antes de cancelar
- [ ] Chamada ao `GenerationService.cancelGeneration()` funcional
- [ ] Polling interrompido automaticamente após cancelamento
- [ ] Opção de reiniciar geração após cancelamento
- [ ] Feedback visual de sucesso/erro
- [ ] Testes unitários

## Especificação Técnica

### 1. UI do Botão Cancelar

**O que Implementar:**
- [ ] Botão "Cancelar Geração" visível durante progresso
- [ ] Desabilitado quando não em progresso
- [ ] Ícone visual (ex: stop icon)
- [ ] Positioned destacado na progress bar

**Template HTML:**
```html
<div class="generation-progress">
  <mat-card>
    <mat-card-header>
      <h3>Gerando Documento...</h3>
    </mat-card-header>

    <mat-card-content>
      <!-- Progress Bar -->
      <mat-progress-bar
        mode="determinate"
        [value]="progress"
        *ngIf="isGenerating">
      </mat-progress-bar>

      <!-- Status Text -->
      <p class="status-text">{{ statusMessage }}</p>

      <!-- Progress Details -->
      <p class="progress-details">{{ currentStep }} de {{ totalSteps }}</p>
    </mat-card-content>

    <mat-card-actions>
      <button
        mat-raised-button
        color="warn"
        (click)="onCancelClick()"
        [disabled]="!isGenerating">
        <mat-icon>stop</mat-icon>
        Cancelar Geração
      </button>

      <!-- Reiniciar Button (após cancelamento) -->
      <button
        mat-raised-button
        color="primary"
        (click)="onRestartClick()"
        *ngIf="!isGenerating && isCancelled">
        <mat-icon>refresh</mat-icon>
        Reiniciar Geração
      </button>
    </mat-card-actions>
  </mat-card>
</div>
```

### 2. Modal de Confirmação

**O que Implementar:**
- [ ] Dialog de confirmação antes de cancelar
- [ ] Mensagem clara: "Deseja realmente cancelar?"
- [ ] Botão "Cancelar" (fechar dialog)
- [ ] Botão "Confirmar Cancelamento"

**Código:**
```typescript
onCancelClick() {
  const dialogRef = this.dialog.open(ConfirmationDialogComponent, {
    width: '400px',
    data: {
      title: 'Cancelar Geração?',
      message: 'Você tem certeza que deseja cancelar esta geração? O progresso será perdido.',
      confirmText: 'Cancelar Geração',
      cancelText: 'Não, Continuar'
    }
  });

  dialogRef.afterClosed().subscribe(result => {
    if (result) {
      this.cancelGeneration();
    }
  });
}

private cancelGeneration() {
  this.isLoading = true;
  this.generationService.cancelGeneration(this.taskId)
    .subscribe({
      next: () => {
        this.isGenerating = false;
        this.isCancelled = true;
        this.isLoading = false;
        this.showMessage('Geração cancelada com sucesso', 'success');
        this.stopPolling();
      },
      error: (error) => {
        this.isLoading = false;
        this.showMessage('Erro ao cancelar geração', 'error');
        console.error('Erro ao cancelar:', error);
      }
    });
}
```

### 3. Interrupção de Polling

**O que Implementar:**
- [ ] Parar polling quando cancelamento confirmado
- [ ] Unsubscribe do interval/timer
- [ ] Não fazer mais chamadas de progresso

**Código:**
```typescript
private pollingSubscription: Subscription;

startPolling() {
  this.pollingSubscription = interval(2000)
    .pipe(
      switchMap(() => this.generationService.getProgress(this.taskId)),
      takeWhile(response => response.status !== 'completed' && response.status !== 'cancelled')
    )
    .subscribe({
      next: (response) => {
        this.progress = response.progress;
        this.statusMessage = response.message;
      },
      error: (error) => {
        console.error('Erro ao verificar progresso:', error);
      }
    });
}

private stopPolling() {
  if (this.pollingSubscription) {
    this.pollingSubscription.unsubscribe();
  }
}

ngOnDestroy() {
  this.stopPolling();
}
```

### 4. Reiniciar Geração

**O que Implementar:**
- [ ] Botão "Reiniciar Geração" apareça após cancelamento
- [ ] Ao clicar, voltar ao passo anterior ou recomeçar
- [ ] Reset de estado (progress = 0, isCancelled = false)

**Código:**
```typescript
onRestartClick() {
  this.isCancelled = false;
  this.progress = 0;
  // Voltar ao step anterior ou recomeçar
  this.router.navigate(['/app/generate'], {
    queryParams: {
      template: this.selectedTemplate,
      workspace: this.selectedWorkspace
    }
  });
}
```

## Componentes Afetados

**Arquivo Principal:**
- `src/app/features/generation/components/generation-progress/generation-progress.component.ts`
- `src/app/features/generation/components/generation-progress/generation-progress.component.html`

**Serviço:**
- `src/app/services/generation.service.ts` — deve ter método `cancelGeneration(taskId)`

## Estrutura de Componente Proposta

```typescript
@Component({
  selector: 'app-generation-progress',
  templateUrl: './generation-progress.component.html',
  styleUrls: ['./generation-progress.component.scss']
})
export class GenerationProgressComponent implements OnInit, OnDestroy {
  @Input() taskId: string;

  isGenerating = true;
  isCancelled = false;
  isLoading = false;
  progress = 0;
  statusMessage = 'Iniciando geração...';
  currentStep = 0;
  totalSteps = 3;

  private pollingSubscription: Subscription;

  constructor(
    private generationService: GenerationService,
    private dialog: MatDialog,
    private snackBar: MatSnackBar,
    private router: Router
  ) {}

  ngOnInit() {
    this.startPolling();
  }

  ngOnDestroy() {
    this.stopPolling();
  }

  onCancelClick() {
    const dialogRef = this.dialog.open(ConfirmationDialogComponent, {
      width: '400px',
      data: {
        title: 'Cancelar Geração?',
        message: 'Você tem certeza que deseja cancelar?',
        confirmText: 'Cancelar',
        cancelText: 'Não'
      }
    });

    dialogRef.afterClosed().subscribe(result => {
      if (result) {
        this.cancelGeneration();
      }
    });
  }

  private cancelGeneration() {
    this.isLoading = true;
    this.generationService.cancelGeneration(this.taskId)
      .subscribe({
        next: () => {
          this.isGenerating = false;
          this.isCancelled = true;
          this.isLoading = false;
          this.showMessage('Geração cancelada com sucesso', 'success');
          this.stopPolling();
        },
        error: (error) => {
          this.isLoading = false;
          this.showMessage('Erro ao cancelar', 'error');
        }
      });
  }

  onRestartClick() {
    this.isCancelled = false;
    this.progress = 0;
    this.isGenerating = true;
    this.startPolling();
  }

  private startPolling() {
    this.pollingSubscription = interval(2000)
      .pipe(
        switchMap(() => this.generationService.getProgress(this.taskId)),
        takeWhile(response =>
          response.status !== 'completed' &&
          response.status !== 'cancelled' &&
          response.status !== 'failed'
        )
      )
      .subscribe({
        next: (response) => {
          this.progress = response.progress;
          this.statusMessage = response.message;
          this.currentStep = response.current_step;
        },
        error: (error) => console.error('Erro:', error)
      });
  }

  private stopPolling() {
    if (this.pollingSubscription) {
      this.pollingSubscription.unsubscribe();
    }
  }

  private showMessage(message: string, type: 'success' | 'error') {
    this.snackBar.open(message, 'Fechar', {
      duration: 3000,
      panelClass: [`snackbar-${type}`]
    });
  }
}
```

## Orientações de Implementação

1. **Confirmação Dupla**
   - Sempre mostrar modal de confirmação
   - Deixar claro que operação é irreversível

2. **Estados Visuais**
   - Em progresso: botão ativo e destacado
   - Cancelado: mostrar mensagem e opção reiniciar
   - Erro: mostrar mensagem e tentar novamente

3. **RxJS Best Practices**
   - Usar `takeWhile()` para parar polling
   - Usar `switchMap()` para combinar observables
   - Unsubscribe no `ngOnDestroy()`

4. **Feedback ao Usuário**
   - Toast de sucesso ao cancelar
   - Toast de erro se falhar
   - Atualizar UI após resposta

## Padrões de Código Obrigatórios
- Seguir padrão async/await do RxJS
- Implementar `OnDestroy` e limpar subscriptions
- Usar Angular Material para dialogs e snackbars
- Adicionar tratamento de erro robusto
- Documentar métodos públicos com JSDoc

## Testes Obrigatórios
**Legenda de status:** `[x]` Concluído · `[~]` Parcial · `[ ]` Pendente

- [ ] Teste: Botão "Cancelar" está desabilitado inicialmente
- [ ] Teste: Ao clicar, abre modal de confirmação
- [ ] Teste: Ao confirmar, chama `cancelGeneration()`
- [ ] Teste: Polling é interrompido após cancelamento
- [ ] Teste: Botão "Reiniciar" aparece após cancelamento
- [ ] Teste: Erro ao cancelar exibe mensagem ao usuário
- [ ] Teste: Subscriptions são limpas no `ngOnDestroy()`

## Estimativa
**Responsável:** Frontend Team
**Deadline:** 16 de Novembro
**Estimativa:** 1 dia
**Status:** ⏳ Não Iniciado

## Links Relacionados
- [agents_vector_dev.md](../frontend/agents_vector_dev.md)
- [Status_Implementação.md](../frontend/status/Status_Implementação.md)
